name: Sync XML to JSON (Complete)

on:
  schedule:
    - cron: '0 */4 * * *'  # æ¯4å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è§¦å‘

jobs:
  sync-jobs:
    runs-on: ubuntu-latest
    timeout-minutes: 60    # è¶…æ—¶é™åˆ¶
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install xmltodict

      # ========================================================
      # ä»»åŠ¡ 1: config-sources (é‡ç‚¹ï¼šXML è½¬ JSON + æ™ºèƒ½åˆ¤æ–­)
      # ========================================================
      - name: Sync config-sources (XML->JSON)
        run: |
          # --- é…ç½®åŒº ---
          SRC="https://github.com/SeerAPI/config-sources.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          
          echo "ğŸ” [1/4] æ£€æŸ¥ç‰ˆæœ¬çŠ¶æ€..."
          
          # 1. è·å– GitHub æœ€æ–°æŒ‡çº¹ (Commit SHA)
          LATEST_SHA=$(git ls-remote $SRC main | awk '{print $1}')
          echo "GitHub æœ€æ–°ç‰ˆæœ¬: $LATEST_SHA"

          # 2. è·å– CNB ä¸Šæ¬¡è®°å½•çš„ç‰ˆæœ¬
          # å…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•ç”¨æ¥æ£€æŸ¥
          mkdir -p check_version
          cd check_version
          git init
          git remote add origin $DEST
          # å°è¯•æ‹‰å– source_version.txtï¼Œå¦‚æœå¤±è´¥è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œ
          git pull origin main --depth 1 || echo "é¦–æ¬¡è¿è¡Œæˆ–æ–‡ä»¶ä¸å­˜åœ¨"
          
          if [ -f source_version.txt ]; then
            RECORDED_SHA=$(cat source_version.txt)
            echo "CNB è®°å½•ç‰ˆæœ¬:   $RECORDED_SHA"
          else
            RECORDED_SHA="none"
            echo "CNB å°šæ— è®°å½•"
          fi
          cd ..
          rm -rf check_version

          # 3. å¯¹æ¯”åˆ¤æ–­
          if [ "$LATEST_SHA" == "$RECORDED_SHA" ]; then
            echo "âœ… ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°ï¼Œè·³è¿‡ï¼"
          else
            echo "ğŸš€ å‘ç°æ–°ç‰ˆæœ¬ï¼Œå¼€å§‹è½¬æ¢æµç¨‹..."
            
            # 4. ä¸‹è½½ GitHub æºç 
            git clone --depth 1 $SRC work_dir
            
            # 5. åˆ›å»ºå¹¶è¿è¡Œ Python è½¬æ¢è„šæœ¬
            echo "ğŸ”„ [2/4] æ­£åœ¨å°† XML è½¬æ¢ä¸º JSON..."
            cat > converter.py <<EOF
          import os, json, xmltodict
          # éå†ç›®å½•
          for root, dirs, files in os.walk("work_dir"):
              if '.git' in dirs: dirs.remove('.git') # å¿½ç•¥gitç›®å½•
              for file in files:
                  if file.endswith(".xml"):
                      try:
                          xml_path = os.path.join(root, file)
                          json_path = os.path.splitext(xml_path)[0] + ".json"
                          
                          # è¯»å– XML å¹¶è½¬ä¸º JSON
                          with open(xml_path, 'r', encoding='utf-8') as f:
                              data = xmltodict.parse(f.read())
                          
                          # å†™å…¥ JSON (indent=None è¡¨ç¤ºå‹ç¼©æ ¼å¼ï¼Œå‡å°ä½“ç§¯)
                          with open(json_path, 'w', encoding='utf-8') as f:
                              json.dump(data, f, ensure_ascii=False, indent=None)
                          
                          # ã€å…³é”®ã€‘åˆ é™¤åŸ XML æ–‡ä»¶
                          os.remove(xml_path)
                      except Exception as e:
                          print(f"Error converting {file}: {e}")
          EOF
            # æ‰§è¡Œè½¬æ¢
            python converter.py
            rm converter.py

            # 6. æ›´æ–°ç‰ˆæœ¬è®°å½•æ–‡ä»¶
            echo $LATEST_SHA > work_dir/source_version.txt
            echo "ğŸ“„ [3/4] ç‰ˆæœ¬è®°å½•å·²æ›´æ–°"

            # 7. æ¨é€ (å¼ºåˆ¶è¦†ç›–)
            echo "ğŸ“¤ [4/4] æ¨é€åˆ° CNB..."
            cd work_dir
            # åˆ é™¤æ—§çš„ git ä¿¡æ¯ï¼Œé‡æ–°åˆå§‹åŒ–ï¼Œç¡®ä¿å®Œå…¨è¦†ç›–
            rm -rf .git
            git init
            git config user.name "CNB Sync Bot"
            git config user.email "bot@cnb.cool"
            git checkout -b main
            
            git add .
            git commit -m "Auto sync XML->JSON (Source: $LATEST_SHA)"
            
            git remote add cnb $DEST
            git push cnb main:main --force
            
            cd ..
            rm -rf work_dir
            echo "âœ… config-sources åŒæ­¥å®Œæˆï¼"
          fi

      # ========================================================
      # ä»»åŠ¡ 2: api-data (æ™®é€šåŒæ­¥ï¼Œæ— è½¬æ¢ï¼Œå¸¦æ™ºèƒ½åˆ¤æ–­)
      # ========================================================
      - name: Sync api-data
        run: |
          SRC="https://github.com/SeerAPI/api-data.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/api-data.git"
          
          echo "ğŸ” æ£€æŸ¥ api-data æ›´æ–°..."
          SRC_ID=$(git ls-remote $SRC main | awk '{print $1}')
          DEST_ID=$(git ls-remote $DEST main | awk '{print $1}')
          
          if [ "$SRC_ID" == "$DEST_ID" ] && [ -n "$SRC_ID" ]; then
             echo "âœ… api-data å·²æ˜¯æœ€æ–°ï¼Œè·³è¿‡ã€‚"
          else
             echo "ğŸš€ åŒæ­¥ api-data..."
             # ä½¿ç”¨ bare å…‹éš†è§£å†³ shallow update é—®é¢˜
             git clone --bare $SRC repo_api
             cd repo_api
             git remote add cnb $DEST
             git push cnb "refs/heads/*:refs/heads/*" --force
             git push cnb "refs/tags/*:refs/tags/*" --force
             cd ..
             rm -rf repo_api
             echo "âœ… api-data åŒæ­¥å®Œæˆï¼"
          fi

      # ========================================================
      # ä»»åŠ¡ 3: seer-unity-assets (å·²æ ¹æ®è¦æ±‚è·³è¿‡)
      # ========================================================
      - name: Sync seer-unity-assets
        run: echo "â›”ï¸ å·²è·³è¿‡èµ„æºä»“åº“åŒæ­¥ã€‚"
