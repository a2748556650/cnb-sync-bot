name: Sync 3 Repos Mixed Logic

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  sync-all:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Setup Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Install Dependencies
        run: pip install xmltodict

      # ========================================================
      # 任务 1: config-sources
      # 逻辑: XML转JS + 缩短文件名 + 智能检查
      # ========================================================
      - name: Sync config-sources (Convert and Rename)
        run: |
          SRC="https://github.com/SeerAPI/config-sources.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          
          echo "Checking config-sources update..."
          LATEST_SHA=$(git ls-remote $SRC main | awk '{print $1}')
          
          # 检查 CNB 里的版本记录
          mkdir check_1
          cd check_1
          git init
          git remote add origin $DEST
          git pull origin main --depth 1 || echo "First run"
          if [ -f source_version.txt ]; then RECORDED=$(cat source_version.txt); else RECORDED="none"; fi
          cd ..
          rm -rf check_1
          
          if [ "$LATEST_SHA" == "$RECORDED" ]; then
             echo "Config-sources match, skipping."
          else
             echo "Config-sources update found, processing..."
             git clone --depth 1 $SRC work_dir_1
             
             # --- 生成 Python 转换脚本 ---
             cat > converter.py <<EOF
          import os, json, xmltodict
          for root, dirs, files in os.walk("work_dir_1"):
              if '.git' in dirs: dirs.remove('.git')
              for file in files:
                  if file.endswith(".xml"):
                      try:
                          xml_path = os.path.join(root, file)
                          
                          # 1. 智能重命名: config.xml.Item.xml -> Item.js
                          short_name = os.path.splitext(file)[0].split('.')[-1] + ".js"
                          js_path = os.path.join(root, short_name)
                          
                          # 2. 读取 (去@前缀)
                          with open(xml_path, 'r', encoding='utf-8') as f:
                              data = xmltodict.parse(f.read(), attr_prefix='')
                          
                          # 3. 写入 JS
                          json_str = json.dumps(data, ensure_ascii=False, indent=2)
                          js_content = "export default " + json_str + ";"
                          
                          with open(js_path, 'w', encoding='utf-8') as f:
                              f.write(js_content)
                          
                          # 4. 清理旧文件
                          os.remove(xml_path)
                          if js_path != xml_path:
                              old_xml_name_js = os.path.splitext(xml_path)[0] + ".js"
                              if os.path.exists(old_xml_name_js) and old_xml_name_js != js_path:
                                  os.remove(old_xml_name_js)
                                  
                      except Exception as e:
                          print(f"Error: {file} - {e}")
          EOF
          
             # 运行转换
             python converter.py
             rm converter.py
             
             # 更新版本记录
             echo $LATEST_SHA > work_dir_1/source_version.txt
             
             # 推送
             cd work_dir_1
             rm -rf .git
             git init
             git config user.name "Web Bot"
             git config user.email "bot@cnb.cool"
             git checkout -b main
             git add .
             git commit -m "Update JS: $LATEST_SHA"
             git remote add cnb $DEST
             git push cnb main:main --force
             cd ..
             rm -rf work_dir_1
             echo "Config-sources done."
          fi

      # ========================================================
      # 任务 2: api-data
      # 逻辑: 原样拉取 + 检查更新
      # ========================================================
      - name: Sync api-data (Direct Mirror)
        run: |
          SRC="https://github.com/SeerAPI/api-data.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/api-data.git"
          
          echo "Checking api-data update..."
          SRC_SHA=$(git ls-remote $SRC main | awk '{print $1}')
          DEST_SHA=$(git ls-remote $DEST main | awk '{print $1}')
          
          if [ "$SRC_SHA" == "$DEST_SHA" ] && [ -n "$SRC_SHA" ]; then
             echo "Api-data match, skipping."
          else
             echo "Api-data update found, syncing..."
             git clone --bare $SRC repo_api
             cd repo_api
             git remote add cnb $DEST
             git push cnb "refs/heads/*:refs/heads/*" --force
             git push cnb "refs/tags/*:refs/tags/*" --force
             cd ..
             rm -rf repo_api
             echo "Api-data done."
          fi

      # ========================================================
      # 任务 3: seer-unity-assets
      # 逻辑: 原样拉取 + 检查更新 (大文件)
      # ========================================================
      - name: Sync seer-unity-assets (Direct Mirror)
        run: |
          SRC="https://github.com/SeerAPI/seer-unity-assets.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/seer-unity-assets.git"
          BRANCH="main"
          
          echo "Checking assets update..."
          SRC_SHA=$(git ls-remote $SRC $BRANCH | awk '{print $1}')
          DEST_SHA=$(git ls-remote $DEST $BRANCH | awk '{print $1}')
          
          if [ "$SRC_SHA" == "$DEST_SHA" ] && [ -n "$SRC_SHA" ]; then
             echo "Assets match, skipping."
          else
             echo "Assets update found, syncing..."
             git config --global http.postBuffer 524288000
             git clone --bare $SRC repo_assets
             cd repo_assets
             git remote add cnb $DEST
             git push cnb "refs/heads/*:refs/heads/*" --force
             git push cnb "refs/tags/*:refs/tags/*" --force
             cd ..
             rm -rf repo_assets
             echo "Assets done."
          fi
