name: XML to JS (Smart Rename)

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  sync-smart-rename:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - run: pip install xmltodict

      - name: Sync config-sources (Smart Rename JS)
        run: |
          SRC="https://github.com/SeerAPI/config-sources.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          
          # 1. æ™ºèƒ½æ£€æŸ¥
          LATEST_SHA=$(git ls-remote $SRC main | awk '{print $1}')
          
          mkdir check
          cd check
          git init
          git remote add origin $DEST
          git pull origin main --depth 1 || echo "First run"
          if [ -f source_version.txt ]; then
             RECORDED=$(cat source_version.txt)
          else
             RECORDED="none"
          fi
          cd ..
          rm -rf check
          
          if [ "$LATEST_SHA" == "$RECORDED" ]; then
             echo "âœ… ç‰ˆæœ¬ä¸€è‡´ï¼Œè·³è¿‡ã€‚"
             exit 0
          fi
          
          # 2. è½¬æ¢
          echo "ğŸš€ å¼€å§‹è½¬æ¢ (æ™ºèƒ½æå–ç®€çŸ­æ–‡ä»¶å)..."
          git clone --depth 1 $SRC work_dir
          
          cat > converter.py <<EOF
          import os, json, xmltodict
          
          for root, dirs, files in os.walk("work_dir"):
              if '.git' in dirs: dirs.remove('.git')
              for file in files:
                  if file.endswith(".xml"):
                      try:
                          xml_path = os.path.join(root, file)
                          
                          # ==========================================
                          # ã€ä¿®æ”¹ç‚¹ã€‘æ™ºèƒ½é‡å‘½åé€»è¾‘
                          # 1. os.path.splitext(file)[0] æ‹¿åˆ° "config.xml.Item"
                          # 2. .split('.')[-1]           æ‹¿åˆ° "Item"
                          # 3. + ".js"                   å˜æˆ "Item.js"
                          # ==========================================
                          
                          file_no_ext = os.path.splitext(file)[0]
                          short_name = file_no_ext.split('.')[-1]
                          js_name = short_name + ".js"
                          
                          js_path = os.path.join(root, js_name)
                          
                          # è¯»å– (æ—  @ å‰ç¼€)
                          with open(xml_path, 'r', encoding='utf-8') as f:
                              data = xmltodict.parse(f.read(), attr_prefix='')
                          
                          # å†™å…¥ JS
                          json_str = json.dumps(data, ensure_ascii=False, indent=2)
                          js_content = "export default " + json_str + ";"
                          
                          with open(js_path, 'w', encoding='utf-8') as f:
                              f.write(js_content)
                          
                          # åˆ é™¤åŸ XML
                          os.remove(xml_path)
                          
                          # (ä¿é™©æªæ–½) å¦‚æœç”Ÿæˆçš„æ–‡ä»¶åå’Œå»æ‰.xmlåçš„åå­—ä¸ä¸€æ ·ï¼Œ
                          # æ¯”å¦‚åŸé€»è¾‘ä¼šç”Ÿæˆ config.xml.Item.jsï¼Œç°åœ¨æˆ‘ä»¬ç”Ÿæˆ Item.js
                          # ç†è®ºä¸Šè¿™æ˜¯æ–°ç¯å¢ƒä¸éœ€è¦æ¸…ç†æ—§JSï¼Œä½†ä¸ºäº†é€»è¾‘ä¸¥è°¨ä¿ç•™æ¸…ç†é€»è¾‘
                          if xml_path != os.path.join(root, file):
                              if os.path.exists(xml_path): os.remove(xml_path)
                          
                      except Exception as e:
                          print(f"Error: {file} - {e}")
          EOF
          
          python converter.py
          rm converter.py

          # 3. æäº¤
          echo $LATEST_SHA > work_dir/source_version.txt
          
          cd work_dir
          rm -rf .git
          git init
          git config user.name "Web Bot"
          git config user.email "bot@cnb.cool"
          git checkout -b main
          git add .
          git commit -m "Update JS (Smart Name): $LATEST_SHA"
          
          git remote add cnb $DEST
          git push cnb main:main --force
          
          echo "âœ… å®Œæˆï¼æ–‡ä»¶åå·²ç¼©çŸ­å¹¶è½¬æ¢ä¸º JSã€‚"
