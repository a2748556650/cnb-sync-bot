name: Auto Sync SeerAPI to CNB

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  sync-all-repos:
    runs-on: ubuntu-latest
    # 【修改点1】改成 120 分钟（2小时），网速慢也能传完
    timeout-minutes: 120
    
    steps:
      - name: Configure Git Network
        run: |
          # 优化 Git 网络设置
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          # 【修改点2】强制使用 HTTP/1.1，防止 HTTP/2 在大文件上传时卡死
          git config --global http.version HTTP/1.1

      # ==============================
      # 任务 1: config-sources
      # ==============================
      - name: Sync config-sources
        run: |
          echo "正在同步 config-sources..."
          git clone --mirror https://github.com/SeerAPI/config-sources.git repo1
          cd repo1
          git remote add cnb "https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          git push cnb "refs/heads/*:refs/heads/*" --force
          git push cnb "refs/tags/*:refs/tags/*" --force
          cd ..
          rm -rf repo1
          echo "config-sources 同步完成 ✅"

      # ==============================
      # 任务 2: seer-unity-assets (巨大仓库)
      # ==============================
      - name: Sync seer-unity-assets
        run: |
          echo "正在同步 seer-unity-assets..."
          # 依然使用 depth 1 保持最小体积
          git clone --depth 1 https://github.com/SeerAPI/seer-unity-assets.git repo2
          
          cd repo2
          git remote add cnb "https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/seer-unity-assets.git"
          
          echo "开始推送到 CNB (可能需要很久，请耐心等待)..."
          git push cnb main:main --force
          
          cd ..
          rm -rf repo2
          echo "seer-unity-assets 同步完成 ✅"

      # ==============================
      # 任务 3: api-data
      # ==============================
      - name: Sync api-data
        run: |
          echo "正在同步 api-data..."
          git clone --mirror https://github.com/SeerAPI/api-data.git repo3
          cd repo3
          git remote add cnb "https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/api-data.git"
          git push cnb "refs/heads/*:refs/heads/*" --force
          git push cnb "refs/tags/*:refs/tags/*" --force
          cd ..
          rm -rf repo3
          echo "api-data 同步完成 ✅"
