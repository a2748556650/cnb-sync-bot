name: Auto Sync SeerAPI to CNB

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  sync-all-repos:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 设置超时，如果超过30分钟自动停止，防止卡死
    
    steps:
      - name: Configure Git for Large Files
        run: |
          # 优化 Git 网络设置，防止大文件传输卡死
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999

      # ==============================
      # 任务 1: config-sources (小仓库，保持全量同步)
      # ==============================
      - name: Sync config-sources
        run: |
          echo "正在同步 config-sources..."
          git clone --mirror https://github.com/SeerAPI/config-sources.git repo1
          cd repo1
          git remote add cnb "https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          # 推送分支和标签
          git push cnb "refs/heads/*:refs/heads/*" --force
          git push cnb "refs/tags/*:refs/tags/*" --force
          cd ..
          rm -rf repo1
          echo "config-sources 同步完成 ✅"

      # ==============================
      # 任务 2: seer-unity-assets (大仓库，只同步最新版！)
      # ==============================
      - name: Sync seer-unity-assets
        run: |
          echo "正在同步 seer-unity-assets..."
          # 【关键修改】加上 --depth 1，只下载最近一次提交
          # 并且去掉 --mirror，改为普通克隆
          git clone --depth 1 https://github.com/SeerAPI/seer-unity-assets.git repo2
          
          cd repo2
          git remote add cnb "https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/seer-unity-assets.git"
          
          # 因为是浅克隆，我们只强制推送 main 分支
          # 如果对方主分支叫 master，请把下面的 main 改成 master
          git push cnb main:main --force
          
          cd ..
          rm -rf repo2
          echo "seer-unity-assets 同步完成 ✅"

      # ==============================
      # 任务 3: api-data (通常较小，全量同步)
      # ==============================
      - name: Sync api-data
        run: |
          echo "正在同步 api-data..."
          git clone --mirror https://github.com/SeerAPI/api-data.git repo3
          cd repo3
          git remote add cnb "https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/api-data.git"
          git push cnb "refs/heads/*:refs/heads/*" --force
          git push cnb "refs/tags/*:refs/tags/*" --force
          cd ..
          rm -rf repo3
          echo "api-data 同步完成 ✅"
