name: Strict XML to JS Sync

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  strict-sync-js:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - run: pip install xmltodict

      - name: Sync config-sources (XML -> JS, Name Kept)
        run: |
          SRC="https://github.com/SeerAPI/config-sources.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          
          # 1. æ™ºèƒ½æ£€æŸ¥
          LATEST_SHA=$(git ls-remote $SRC main | awk '{print $1}')
          
          mkdir check
          cd check
          git init
          git remote add origin $DEST
          git pull origin main --depth 1 || echo "First run"
          if [ -f source_version.txt ]; then
             RECORDED=$(cat source_version.txt)
          else
             RECORDED="none"
          fi
          cd ..
          rm -rf check
          
          if [ "$LATEST_SHA" == "$RECORDED" ]; then
             echo "âœ… ç‰ˆæœ¬ä¸€è‡´ï¼Œè·³è¿‡ã€‚"
             exit 0
          fi
          
          # 2. è½¬æ¢
          echo "ğŸš€ å¼€å§‹è½¬æ¢ (ä¿ç•™åŸæ–‡ä»¶å)..."
          git clone --depth 1 $SRC work_dir
          
          cat > converter.py <<EOF
          import os, json, xmltodict
          
          for root, dirs, files in os.walk("work_dir"):
              if '.git' in dirs: dirs.remove('.git')
              for file in files:
                  if file.endswith(".xml"):
                      try:
                          xml_path = os.path.join(root, file)
                          
                          # ã€ä¸¥æ ¼ä¿ç•™åŸåé€»è¾‘ã€‘
                          # åªå»æ‰æœ€åé¢çš„ .xmlï¼Œæ¢æˆ .js
                          # ä¾‹å¦‚: config.xml.Item.xml -> config.xml.Item.js
                          base_name = os.path.splitext(file)[0]
                          js_name = base_name + ".js"
                          js_path = os.path.join(root, js_name)
                          
                          # è¯»å– (æ—  @ å‰ç¼€)
                          with open(xml_path, 'r', encoding='utf-8') as f:
                              data = xmltodict.parse(f.read(), attr_prefix='')
                          
                          # å†™å…¥ JS
                          json_str = json.dumps(data, ensure_ascii=False, indent=2)
                          js_content = "export default " + json_str + ";"
                          
                          with open(js_path, 'w', encoding='utf-8') as f:
                              f.write(js_content)
                          
                          # åˆ é™¤åŸ XML
                          os.remove(xml_path)
                          
                      except Exception as e:
                          print(f"Error: {file} - {e}")
          EOF
          
          python converter.py
          rm converter.py

          # 3. æäº¤
          echo $LATEST_SHA > work_dir/source_version.txt
          
          cd work_dir
          rm -rf .git
          git init
          git config user.name "Web Bot"
          git config user.email "bot@cnb.cool"
          git checkout -b main
          git add .
          git commit -m "Update JS (Strict Name): $LATEST_SHA"
          
          git remote add cnb $DEST
          git push cnb main:main --force
          
          echo "âœ… å®Œæˆï¼æ–‡ä»¶åå·²å®Œç¾ä¿ç•™ã€‚"
