name: Smart Sync SeerAPI to CNB

on:
  schedule:
    - cron: '0 */4 * * *' # æ¯4å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  smart-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # è®¾ç½®ä¸º6å°æ—¶ï¼Œä¿è¯å…¨é‡ä¼ è¾“ç»å¯¹å¤Ÿç”¨
    
    steps:
      - name: Configure Git Network
        run: |
          # æè‡´ä¼˜åŒ–ç½‘ç»œï¼Œé˜²æ­¢å¤§æ–‡ä»¶ä¸­æ–­
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global http.version HTTP/1.1
          git config --global compression.codec none

      # ========================================================
      # ä»»åŠ¡ 1: config-sources
      # ========================================================
      - name: Sync config-sources
        run: |
          SRC="https://github.com/SeerAPI/config-sources.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          
          echo "æ­£åœ¨æ£€æŸ¥æ›´æ–°..."
          SRC_ID=$(git ls-remote $SRC main | awk '{print $1}')
          DEST_ID=$(git ls-remote $DEST main | awk '{print $1}')
          
          if [ "$SRC_ID" == "$DEST_ID" ] && [ -n "$SRC_ID" ]; then
            echo "âœ… config-sources å·²ç»æ˜¯æœ€æ–°ï¼Œè·³è¿‡ã€‚"
          else
            echo "ğŸš€ å‘ç°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
            # ä½¿ç”¨è£¸å…‹éš† (--bare) é€Ÿåº¦å¿«ï¼Œä¸”ä¿ç•™å®Œæ•´å†å²è§£å†³ shallow update é—®é¢˜
            git clone --bare $SRC repo1
            cd repo1
            git remote add cnb $DEST
            # åªæ¨é€åˆ†æ”¯å’Œæ ‡ç­¾ï¼Œä¸æ¨ Pull Requestï¼Œé˜²æ­¢æŠ¥é”™
            git push cnb "refs/heads/*:refs/heads/*" --force
            git push cnb "refs/tags/*:refs/tags/*" --force
            cd ..
            rm -rf repo1
            echo "åŒæ­¥å®Œæˆ âœ…"
          fi

      # ========================================================
      # ä»»åŠ¡ 2: seer-unity-assets (å·¨å¤§ä»“åº“ - é‡ç‚¹ä¿®å¤)
      # ========================================================
      - name: Sync seer-unity-assets
        run: |
          SRC="https://github.com/SeerAPI/seer-unity-assets.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/seer-unity-assets.git"
          # å‡è®¾å¯¹æ–¹ä¸»åˆ†æ”¯æ˜¯ mainï¼Œå¦‚æœæ˜¯ master è¯·è‡ªè¡Œä¿®æ”¹
          BRANCH="main"
          
          echo "æ­£åœ¨æ£€æŸ¥å¤§ä»“åº“æ›´æ–°..."
          SRC_ID=$(git ls-remote $SRC $BRANCH | awk '{print $1}')
          DEST_ID=$(git ls-remote $DEST $BRANCH | awk '{print $1}')
          
          echo "GitHub: $SRC_ID"
          echo "CNB   : $DEST_ID"
          
          if [ "$SRC_ID" == "$DEST_ID" ] && [ -n "$SRC_ID" ]; then
            echo "âœ… seer-unity-assets å·²ç»æ˜¯æœ€æ–°ï¼Œè·³è¿‡ (è¿™ä¸ºä½ èŠ‚çœäº†å¤§é‡æ—¶é—´)ã€‚"
          else
            echo "ğŸš€ å‘ç°æ›´æ–°ï¼å› ä¸º CNB ä¸æ”¯æŒæµ…å…‹éš†ï¼Œå¿…é¡»è¿›è¡Œå…¨é‡ä¸‹è½½..."
            echo "â³ è¿™å¯èƒ½éœ€è¦ 10-30 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…..."
            
            # ã€å…³é”®ä¿®å¤ã€‘
            # 1. å»æ‰ --depth 1 (è§£å†³ shallow update not allowed)
            # 2. ä½¿ç”¨ --bare (ä¸è§£å‹æ–‡ä»¶ï¼Œåªä¸‹è½½ .git æ•°æ®ï¼Œæ¯”æ™®é€š clone å¿«å¾ˆå¤šä¸”çœç©ºé—´)
            git clone --bare $SRC repo2
            
            cd repo2
            git remote add cnb $DEST
            
            echo "æ­£åœ¨æ¨é€åˆ° CNB..."
            # å¼ºåˆ¶æ¨é€æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾
            git push cnb "refs/heads/*:refs/heads/*" --force
            git push cnb "refs/tags/*:refs/tags/*" --force
            
            cd ..
            rm -rf repo2
            echo "åŒæ­¥å®Œæˆ âœ…"
          fi

      # ========================================================
      # ä»»åŠ¡ 3: api-data
      # ========================================================
      - name: Sync api-data
        run: |
          SRC="https://github.com/SeerAPI/api-data.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/api-data.git"
          
          echo "æ­£åœ¨æ£€æŸ¥æ›´æ–°..."
          SRC_ID=$(git ls-remote $SRC main | awk '{print $1}')
          DEST_ID=$(git ls-remote $DEST main | awk '{print $1}')
          
          if [ "$SRC_ID" == "$DEST_ID" ] && [ -n "$SRC_ID" ]; then
            echo "âœ… api-data å·²ç»æ˜¯æœ€æ–°ï¼Œè·³è¿‡ã€‚"
          else
            echo "ğŸš€ å‘ç°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
            git clone --bare $SRC repo3
            cd repo3
            git remote add cnb $DEST
            git push cnb "refs/heads/*:refs/heads/*" --force
            git push cnb "refs/tags/*:refs/tags/*" --force
            cd ..
            rm -rf repo3
            echo "åŒæ­¥å®Œæˆ âœ…"
          fi
