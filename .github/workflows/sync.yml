name: Auto Sync SeerAPI to CNB

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  sync-all-repos:
    runs-on: ubuntu-latest
    steps:
      # ==============================
      # 任务 1: config-sources
      # ==============================
      - name: Sync config-sources
        run: |
          echo "正在同步 config-sources..."
          # 1. 下载源仓库所有信息
          git clone --mirror https://github.com/SeerAPI/config-sources.git repo1
          cd repo1
          
          # 2. 设置 CNB 目标
          git remote add cnb "https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          
          # 3. 【修复点】只推送分支和标签，忽略 Pull Request
          git push cnb "refs/heads/*:refs/heads/*" --force
          git push cnb "refs/tags/*:refs/tags/*" --force
          
          # 4. 清理
          cd ..
          rm -rf repo1
          echo "config-sources 同步完成 ✅"

      # ==============================
      # 任务 2: seer-unity-assets
      # ==============================
      - name: Sync seer-unity-assets
        run: |
          echo "正在同步 seer-unity-assets..."
          git clone --mirror https://github.com/SeerAPI/seer-unity-assets.git repo2
          cd repo2
          git remote add cnb "https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/seer-unity-assets.git"
          
          # 【修复点】
          git push cnb "refs/heads/*:refs/heads/*" --force
          git push cnb "refs/tags/*:refs/tags/*" --force
          
          cd ..
          rm -rf repo2
          echo "seer-unity-assets 同步完成 ✅"

      # ==============================
      # 任务 3: api-data
      # ==============================
      - name: Sync api-data
        run: |
          echo "正在同步 api-data..."
          git clone --mirror https://github.com/SeerAPI/api-data.git repo3
          cd repo3
          git remote add cnb "https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/api-data.git"
          
          # 【修复点】
          git push cnb "refs/heads/*:refs/heads/*" --force
          git push cnb "refs/tags/*:refs/tags/*" --force
          
          cd ..
          rm -rf repo3
          echo "api-data 同步完成 ✅"
