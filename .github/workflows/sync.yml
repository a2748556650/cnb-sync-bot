name: Sync 3 Repos (Mixed Logic)

on:
  schedule:
    - cron: '0 */4 * * *'  # æ¯4å°æ—¶è¿è¡Œ
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  sync-all:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6å°æ—¶è¶…æ—¶ï¼Œé˜²æ­¢å¤§æ–‡ä»¶ä¼ ä¸å®Œ
    
    steps:
      - name: Setup Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - run: pip install xmltodict
      # ========================================================
      # ä»“åº“ 1: config-sources 
      # ã€ç‰¹æ®Šå¤„ç†ã€‘ï¼šXMLè½¬JS + ç¼©çŸ­æ–‡ä»¶å + æ™ºèƒ½æ£€æŸ¥
      # ========================================================
      - name: [1/3] Sync config-sources (Convert & Rename)
        run: |
          SRC="https://github.com/SeerAPI/config-sources.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          
          echo "ğŸ” æ£€æŸ¥ config-sources æ›´æ–°..."
          LATEST_SHA=$(git ls-remote $SRC main | awk '{print $1}')
          
          # æ£€æŸ¥ CNB é‡Œçš„ç‰ˆæœ¬è®°å½•æ–‡ä»¶
          mkdir check_1
          cd check_1
          git init
          git remote add origin $DEST
          git pull origin main --depth 1 || echo "First run"
          if [ -f source_version.txt ]; then RECORDED=$(cat source_version.txt); else RECORDED="none"; fi
          cd ..
          rm -rf check_1
          
          if [ "$LATEST_SHA" == "$RECORDED" ]; then
             echo "âœ… config-sources ç‰ˆæœ¬ä¸€è‡´ï¼Œè·³è¿‡ã€‚"
          else
             echo "ğŸš€ config-sources å‘ç°æ›´æ–°ï¼Œå¼€å§‹è½¬æ¢..."
             git clone --depth 1 $SRC work_dir_1
             
             # --- Python è½¬æ¢è„šæœ¬ (å«é‡å‘½åé€»è¾‘) ---
             cat > converter.py <<EOF
          import os, json, xmltodict
          for root, dirs, files in os.walk("work_dir_1"):
              if '.git' in dirs: dirs.remove('.git')
              for file in files:
                  if file.endswith(".xml"):
                      try:
                          xml_path = os.path.join(root, file)
                          
                          # 1. æ™ºèƒ½é‡å‘½å: config.xml.Item.xml -> Item.js
                          short_name = os.path.splitext(file)[0].split('.')[-1] + ".js"
                          js_path = os.path.join(root, short_name)
                          
                          # 2. è¯»å– (å»@å‰ç¼€)
                          with open(xml_path, 'r', encoding='utf-8') as f:
                              data = xmltodict.parse(f.read(), attr_prefix='')
                          
                          # 3. å†™å…¥ JS
                          json_str = json.dumps(data, ensure_ascii=False, indent=2)
                          js_content = "export default " + json_str + ";"
                          
                          with open(js_path, 'w', encoding='utf-8') as f:
                              f.write(js_content)
                          
                          # 4. æ¸…ç†æ—§æ–‡ä»¶
                          os.remove(xml_path)
                          if js_path != xml_path: # å¦‚æœæ–°è€è·¯å¾„ä¸ä¸€æ ·ï¼Œæ£€æŸ¥æœ‰æ²¡æœ‰æ®‹ç•™çš„æ—§åŒåæ–‡ä»¶
                              old_xml_name_js = os.path.splitext(xml_path)[0] + ".js"
                              if os.path.exists(old_xml_name_js) and old_xml_name_js != js_path:
                                  os.remove(old_xml_name_js)
                                  
                      except Exception as e:
                          print(f"Error: {file} - {e}")
          EOF
             # è¿è¡Œè½¬æ¢
             python converter.py
             rm converter.py
             
             # æ›´æ–°ç‰ˆæœ¬è®°å½•
             echo $LATEST_SHA > work_dir_1/source_version.txt
             
             # æ¨é€
             cd work_dir_1
             rm -rf .git
             git init
             git config user.name "Web Bot"
             git config user.email "bot@cnb.cool"
             git checkout -b main
             git add .
             git commit -m "Update JS: $LATEST_SHA"
             git remote add cnb $DEST
             git push cnb main:main --force
             cd ..
             rm -rf work_dir_1
             echo "âœ… config-sources å®Œæˆ"
          fi

      # ========================================================
      # ä»“åº“ 2: api-data
      # ã€æ™®é€šåŒæ­¥ã€‘ï¼šåŸæ ·æ‹‰å– + æ£€æŸ¥æ›´æ–°
      # ========================================================
      - name: [2/3] Sync api-data (Direct Mirror)
        run: |
          SRC="https://github.com/SeerAPI/api-data.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/api-data.git"
          
          echo "ğŸ” æ£€æŸ¥ api-data æ›´æ–°..."
          # å› ä¸ºæ˜¯åŸæ ·åŒæ­¥ï¼Œå¯ä»¥ç›´æ¥å¯¹æ¯” GitHub å’Œ CNB çš„ Commit ID
          SRC_SHA=$(git ls-remote $SRC main | awk '{print $1}')
          DEST_SHA=$(git ls-remote $DEST main | awk '{print $1}')
          
          if [ "$SRC_SHA" == "$DEST_SHA" ] && [ -n "$SRC_SHA" ]; then
             echo "âœ… api-data å·²æ˜¯æœ€æ–°ï¼Œè·³è¿‡ã€‚"
          else
             echo "ğŸš€ api-data å‘ç°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
             # ä½¿ç”¨ bare å…‹éš†ï¼Œé€Ÿåº¦æœ€å¿«ï¼Œå®Œç¾ä¿ç•™åŸæ–‡ä»¶
             git clone --bare $SRC repo_api
             cd repo_api
             git remote add cnb $DEST
             git push cnb "refs/heads/*:refs/heads/*" --force
             git push cnb "refs/tags/*:refs/tags/*" --force
             cd ..
             rm -rf repo_api
             echo "âœ… api-data å®Œæˆ"
          fi

      # ========================================================
      # ä»“åº“ 3: seer-unity-assets
      # ã€æ™®é€šåŒæ­¥ã€‘ï¼šåŸæ ·æ‹‰å– + æ£€æŸ¥æ›´æ–° (å¤§æ–‡ä»¶)
      # ========================================================
      - name: [3/3] Sync seer-unity-assets (Direct Mirror)
        run: |
          SRC="https://github.com/SeerAPI/seer-unity-assets.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/seer-unity-assets.git"
          # æ³¨æ„ï¼šè¯·ç¡®è®¤è¯¥ä»“åº“ä¸»åˆ†æ”¯æ˜¯ main è¿˜æ˜¯ masterï¼Œè¿™é‡Œå‡è®¾ main
          BRANCH="main"
          
          echo "ğŸ” æ£€æŸ¥ seer-unity-assets æ›´æ–°..."
          SRC_SHA=$(git ls-remote $SRC $BRANCH | awk '{print $1}')
          DEST_SHA=$(git ls-remote $DEST $BRANCH | awk '{print $1}')
          
          if [ "$SRC_SHA" == "$DEST_SHA" ] && [ -n "$SRC_SHA" ]; then
             echo "âœ… assets å·²æ˜¯æœ€æ–°ï¼Œè·³è¿‡ã€‚"
          else
             echo "ğŸš€ assets å‘ç°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥ (è¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´)..."
             
             # é’ˆå¯¹å¤§æ–‡ä»¶ä»“åº“çš„ç½‘ç»œä¼˜åŒ–
             git config --global http.postBuffer 524288000
             
             # ä½¿ç”¨ bare å…‹éš†é¿å…ä¸‹è½½æ–‡ä»¶åˆ°å·¥ä½œåŒºï¼ŒèŠ‚çœç©ºé—´å’Œæ—¶é—´
             git clone --bare $SRC repo_assets
             cd repo_assets
             git remote add cnb $DEST
             git push cnb "refs/heads/*:refs/heads/*" --force
             git push cnb "refs/tags/*:refs/tags/*" --force
             cd ..
             rm -rf repo_assets
             echo "âœ… assets å®Œæˆ"
          fi
