name: XML to JS (Web Game)

on:
  schedule:
    - cron: '0 */4 * * *'  # æ¯4å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-xml-to-js:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - run: pip install xmltodict

      # ==========================================
      # ä»»åŠ¡: config-sources (XML è½¬ JS)
      # ==========================================
      - name: Sync config-sources to JS
        run: |
          # --- é…ç½® ---
          SRC="https://github.com/SeerAPI/config-sources.git"
          DEST="https://oauth2:${{ secrets.CNB_TOKEN }}@cnb.cool/seer_unity/config-sources.git"
          
          # 1. æ™ºèƒ½æ£€æŸ¥æ›´æ–° (å¯¹æ¯” Commit ID)
          LATEST_SHA=$(git ls-remote $SRC main | awk '{print $1}')
          
          # æ£€æŸ¥ CNB é‡Œæ˜¯å¦æœ‰è®°å½•
          mkdir check
          cd check
          git init
          git remote add origin $DEST
          git pull origin main --depth 1 || echo "First run"
          if [ -f source_version.txt ]; then
             RECORDED=$(cat source_version.txt)
          else
             RECORDED="none"
          fi
          cd ..
          rm -rf check
          
          # å¦‚æœç‰ˆæœ¬ä¸€è‡´ï¼Œç›´æ¥åœæ­¢
          if [ "$LATEST_SHA" == "$RECORDED" ]; then
             echo "âœ… ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°ã€‚"
             exit 0
          fi
          
          # 2. å¼€å§‹è½¬æ¢
          echo "ğŸš€ å‘ç°æ–°ç‰ˆæœ¬ï¼Œå¼€å§‹è½¬æ¢ä¸º JS..."
          git clone --depth 1 $SRC work_dir
          
          # åˆ›å»ºè½¬æ¢è„šæœ¬
          cat > converter.py <<EOF
          import os, json, xmltodict
          
          for root, dirs, files in os.walk("work_dir"):
              if '.git' in dirs: dirs.remove('.git')
              for file in files:
                  if file.endswith(".xml"):
                      try:
                          xml_path = os.path.join(root, file)
                          
                          # [æ–‡ä»¶åä¼˜åŒ–] å»æ‰ .xmlï¼Œæ”¹ä¸º .js
                          # config.xml.Item.xml -> config.Item.js
                          clean_name = file.replace('.xml', '') + ".js"
                          js_path = os.path.join(root, clean_name)
                          
                          # [è¯»å–] å»æ‰ @ å‰ç¼€ï¼Œä¿æŒçº¯å‡€æ•°æ®
                          with open(xml_path, 'r', encoding='utf-8') as f:
                              data = xmltodict.parse(f.read(), attr_prefix='')
                          
                          # [è½¬æ¢] åŒ…è£…æˆ export default { ... }
                          json_str = json.dumps(data, ensure_ascii=False, indent=2)
                          js_content = "export default " + json_str + ";"
                          
                          # [å†™å…¥] JS æ–‡ä»¶
                          with open(js_path, 'w', encoding='utf-8') as f:
                              f.write(js_content)
                          
                          # [æ¸…ç†] åˆ é™¤åŸ XML
                          os.remove(xml_path)
                          
                          # åˆ é™¤æ—§åæ–‡ä»¶ï¼ˆå¦‚æœæ”¹åäº†çš„è¯ï¼‰
                          if xml_path != os.path.join(root, file):
                              if os.path.exists(xml_path): os.remove(xml_path)

                      except Exception as e:
                          print(f"Error: {file} - {e}")
          EOF
          
          python converter.py
          rm converter.py

          # 3. æ¨é€æ›´æ–°
          echo $LATEST_SHA > work_dir/source_version.txt
          
          cd work_dir
          rm -rf .git
          git init
          git config user.name "Web Sync Bot"
          git config user.email "bot@cnb.cool"
          git checkout -b main
          git add .
          git commit -m "Auto Update: XML to JS ($LATEST_SHA)"
          
          git remote add cnb $DEST
          git push cnb main:main --force
          
          echo "âœ… JS æ–‡ä»¶åŒæ­¥å®Œæˆï¼"
